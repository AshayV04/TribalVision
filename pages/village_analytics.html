<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Village Analytics - TribalVision</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* CHART CONTAINER FIX */
        /* CHART CONTAINER FIX */
        /* CHART CONTAINER FIX */
        .h-64 {
            height: 300px !important;
            position: relative;  /* Ensures Chart.js can fit properly */
        }

        #trendsChart {
            width: 100% !important;
            height: 100% !important;
}



        canvas {
            display: block !important;
        }

        /* Your existing styles... */
        
        /* Enhanced Layer Control Styles */
        .enhanced-layer-control {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .layer-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 12px;
            padding-bottom: 8px;
        }
        
        .layer-control-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        
        .layer-section {
            margin-bottom: 16px;
        }
        
        .layer-section h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .layer-options {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .layer-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .layer-option:hover {
            background-color: #f3f4f6;
        }
        
        .layer-option input[type="radio"],
        .layer-option input[type="checkbox"] {
            margin: 0;
        }
        
        .layer-option span {
            font-size: 12px;
            color: #374151;
            flex: 1;
        }
        
        .opacity-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .opacity-controls label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #6b7280;
        }
        
        .opacity-controls input[type="range"] {
            width: 80px;
        }
        
        .custom-div-icon {
            background: none;
            border: none;
            text-align: center;
        }

        #toggleLayerControl {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 14px;
            box-shadow: 0 18px 30px -15px rgba(15, 23, 42, 0.4);
            border: 1px solid #d1d5db;
            padding: 0;
        }

        .leaflet-popup-tip {
            background: linear-gradient(135deg, #2563eb, #1e40af);
        }

        .leaflet-popup-content {
            margin: 0;
        }

        .popup-card {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px 18px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(15, 118, 110, 0.05));
            border-radius: 14px;
        }

        .popup-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: #eef2ff;
            color: #1e3a8a;
        }

        .popup-title {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .popup-meta {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #2563eb;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .popup-desc {
            font-size: 12px;
            line-height: 1.45;
            color: #4b5563;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(37, 99, 235, 0.08);
            color: #1e3a8a;
            margin-bottom: 8px;
        }
        </style>
        
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Ffraatlas6365back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body class="bg-background" style="height: 100vh;">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-border-light">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo and Title -->
                <div class="flex items-center">
                    <div class="bg-800 p-1 rounded-lg mr-1">
                        <img src="../TribalVision Logo.png" alt="TribalVision logo" class="logo-mark" style="height: 90px; width: 110px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.25));" />
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-primary-700 tracking-wide ">TribalVision</p>
                        <p class="text-sm text-text-secondary">Village Analytics Dashboard</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex items-center gap-6">
                    <a href="main_dashboard.html" class="text-text-secondary hover:text-primary-600 transition-colors">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="fra_claims_management.html" class="text-text-secondary hover:text-primary-600 transition-colors">
                        <i class="fas fa-file-alt mr-2"></i>Claims
                    </a>
                    <a href="ai_asset_mapping.html" class="text-text-secondary hover:text-primary-600 transition-colors">
                        <i class="fas fa-satellite mr-2"></i>AI Mapping
                    </a>
                    <a href="scheme_recommendations.html" class="text-text-secondary hover:text-primary-600 transition-colors">
                        <i class="fas fa-lightbulb mr-2"></i>Recommendations
                    </a>
                    <a href="village_analytics.html" class="text-primary-600 font-medium">
                        <i class="fas fa-chart-line mr-2"></i>Analytics
                    </a>
                </nav>

                <!-- User Menu -->
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-sm text-text-secondary">
                        <i class="fas fa-sync-alt text-secondary-600"></i>
                        <span>Last updated: 10/09/2025 11:37</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-primary-600 text-sm"></i>
                        </div>
                        <span class="text-sm font-medium text-text-primary">Admin User</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 p-6">
        <!-- Village Selection and Controls -->
        <div class="floating-panel p-6 mb-6">
            <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Village Selection -->
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">
                            <i class="fas fa-map-marker-alt mr-2 text-primary-600"></i>
                            Select Village
                        </label>
                        <select id="villageSelect" class="form-input w-full">
                            <option value="village1">Khairwani Village, Balaghat</option>
                            <option value="village2">Mandla Village, Mandla</option>
                            <option value="village3">Seoni Village, Seoni</option>
                            <option value="village4">Dindori Village, Dindori</option>
                        </select>
                    </div>

                    <!-- District Filter -->
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">
                            <i class="fas fa-filter mr-2 text-primary-600"></i>
                            District Filter
                        </label>
                        <select id="districtFilter" class="form-input w-full">
                            <option value="all">All Districts</option>
                            <option value="balaghat">Balaghat</option>
                            <option value="mandla">Mandla</option>
                            <option value="seoni">Seoni</option>
                            <option value="dindori">Dindori</option>
                        </select>
                    </div>

                    <!-- Search -->
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">
                            <i class="fas fa-search mr-2 text-primary-600"></i>
                            Search Villages
                        </label>
                        <input type="text" id="villageSearch" class="form-input w-full" placeholder="Search by village name..." />
                    </div>
                </div>

                <!-- Export Controls -->
                <div class="flex gap-2">
                    <button class="btn-secondary px-4 py-2 text-sm">
                        <i class="fas fa-download mr-2"></i>Export Report
                    </button>
                    <button class="btn-primary px-4 py-2 text-sm">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Analytics Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Map Section -->
            <div class="xl:col-span-2">
                <div class="floating-panel p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-text-primary">
                            <i class="fas fa-map mr-2 text-primary-600"></i>
                            Village Geospatial Analysis
                        </h2>
                        <div class="flex gap-2">
                            <button id="layerToggle" class="px-3 py-1 text-sm border border-border-light rounded-md hover:bg-gray-50 transition-colors">
                                <i class="fas fa-layer-group mr-1"></i>Layers
                            </button>
                            <button id="fullscreenMap" class="px-3 py-1 text-sm border border-border-light rounded-md hover:bg-gray-50 transition-colors">
                                <i class="fas fa-expand mr-1"></i>Fullscreen
                            </button>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="villageMap" class="w-full h-96 lg:h-[500px] rounded-lg border border-border-light relative">
                        <!-- Map will be initialized here -->
                        <div class="absolute inset-0 bg-gray-100 rounded-lg flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-map text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">Interactive Map Loading...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Map Legend -->
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-sm font-medium text-text-primary mb-3">Map Legend</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-secondary-500 rounded"></div>
                                <span>Forest Cover</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-warning rounded"></div>
                                <span>Agricultural Land</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-primary-500 rounded"></div>
                                <span>Water Bodies</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-accent-500 rounded"></div>
                                <span>FRA Claims</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Panel -->
            <div class="space-y-6">
                <!-- Village Overview -->
                <div class="floating-panel p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">
                        <i class="fas fa-info-circle mr-2 text-primary-600"></i>
                        Village Overview
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-text-secondary">Total Population</span>
                            <span class="font-semibold text-text-primary">2,847</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-text-secondary">Tribal Households</span>
                            <span class="font-semibold text-text-primary">456</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-text-secondary">Total Area</span>
                            <span class="font-semibold text-text-primary">1,245 hectares</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-text-secondary">Forest Coverage</span>
                            <span class="font-semibold text-secondary-600">68.5%</span>
                        </div>
                    </div>
                </div>

                <!-- FRA Claims Status -->
                <div class="floating-panel p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">
                        <i class="fas fa-file-alt mr-2 text-primary-600"></i>
                        FRA Claims Status
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-text-secondary">Completion Rate</span>
                                <span class="font-semibold text-text-primary">78.5%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill success" style="width: 78.5%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="p-3 bg-secondary-50 rounded-lg">
                                <div class="text-lg font-semibold text-secondary-600">142</div>
                                <div class="text-xs text-text-secondary">Approved</div>
                            </div>
                            <div class="p-3 bg-warning/10 rounded-lg">
                                <div class="text-lg font-semibold text-warning">39</div>
                                <div class="text-xs text-text-secondary">Pending</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scheme Participation -->
                <div class="floating-panel p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">
                        <i class="fas fa-users mr-2 text-primary-600"></i>
                        Scheme Participation
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-text-secondary">PM-KISAN</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium">234</span>
                                <div class="w-16 h-2 bg-gray-200 rounded-full">
                                    <div class="h-full bg-secondary-500 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-text-secondary">DAJGUA</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium">189</span>
                                <div class="w-16 h-2 bg-gray-200 rounded-full">
                                    <div class="h-full bg-primary-500 rounded-full" style="width: 68%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-text-secondary">Jal Shakti</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium">156</span>
                                <div class="w-16 h-2 bg-gray-200 rounded-full">
                                    <div class="h-full bg-accent-500 rounded-full" style="width: 56%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <!-- Comparative Analysis -->
            <div class="floating-panel p-6">
                <h3 class="text-lg font-semibold text-text-primary mb-4">
                    <i class="fas fa-chart-bar mr-2 text-primary-600"></i>
                    Comparative Analysis
                </h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-text-secondary">vs District Average</span>
                            <span class="text-sm font-medium text-secondary-600">+12.3%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill success" style="width: 67%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-text-secondary">vs State Average</span>
                            <span class="text-sm font-medium text-warning">-5.8%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill warning" style="width: 45%"></div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="mt-6 grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-primary-50 rounded-lg">
                        <div class="text-lg font-semibold text-primary-600">8.2</div>
                        <div class="text-xs text-text-secondary">Water Index</div>
                    </div>
                    <div class="text-center p-3 bg-secondary-50 rounded-lg">
                        <div class="text-lg font-semibold text-secondary-600">92%</div>
                        <div class="text-xs text-text-secondary">Infrastructure Score</div>
                    </div>
                </div>
            </div>

            <!-- Intervention Priority -->
            <div class="floating-panel p-6">
                <h3 class="text-lg font-semibold text-text-primary mb-4">
                    <i class="fas fa-exclamation-triangle mr-2 text-warning"></i>
                    Intervention Priority
                </h3>
                
                <!-- Priority Score -->
                <div class="text-center mb-6">
                    <div class="text-3xl font-bold text-warning mb-2">Medium</div>
                    <div class="text-sm text-text-secondary">Priority Level</div>
                </div>

                <!-- Priority Factors -->
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-text-secondary">Water Access</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 h-2 bg-gray-200 rounded-full">
                                <div class="h-full bg-accent-500 rounded-full" style="width: 35%"></div>
                            </div>
                            <span class="text-sm font-medium text-accent-600">Low</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-text-secondary">Agricultural Support</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 h-2 bg-gray-200 rounded-full">
                                <div class="h-full bg-warning rounded-full" style="width: 65%"></div>
                            </div>
                            <span class="text-sm font-medium text-warning">Medium</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-text-secondary">Infrastructure</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 h-2 bg-gray-200 rounded-full">
                                <div class="h-full bg-secondary-500 rounded-full" style="width: 85%"></div>
                            </div>
                            <span class="text-sm font-medium text-secondary-600">High</span>
                        </div>
                    </div>
                </div>

                <!-- Recommended Actions -->
                <div class="mt-4 p-3 bg-warning/10 rounded-lg">
                    <h4 class="text-sm font-medium text-text-primary mb-2">Recommended Actions:</h4>
                    <ul class="text-xs text-text-secondary space-y-1">
                        <li>• Improve water infrastructure access</li>
                        <li>• Enhance agricultural extension services</li>
                        <li>• Monitor FRA claim processing</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Data Trends Chart -->
        <div class="floating-panel p-6 mt-6">
            <h3 class="text-lg font-semibold text-text-primary mb-4">
                <i class="fas fa-chart-line mr-2 text-primary-600"></i>
                Village Development Trends
            </h3>
            <div class="h-64">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Layer Control Modal -->
    <div id="layerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-text-primary">Map Layers</h3>
                <button id="closeLayerModal" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-3">
                <label class="flex items-center">
                    <input type="checkbox" id="villageLayer" checked class="rounded border-border-light text-primary-600 focus:ring-primary-500" />
                    <span class="ml-2 text-sm">Village Boundaries</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="fraLayer" checked class="rounded border-border-light text-primary-600 focus:ring-primary-500" />
                    <span class="ml-2 text-sm">FRA Claims</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="landUseLayer" checked class="rounded border-border-light text-primary-600 focus:ring-primary-500" />
                    <span class="ml-2 text-sm">Land Use Classification</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="infrastructureLayer" class="rounded border-border-light text-primary-600 focus:ring-primary-500" />
                    <span class="ml-2 text-sm">Infrastructure</span>
                </label>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="applyLayers" class="flex-1 btn-primary">Apply Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize map
        

        let villageMap;
        let baseLayers = {};
        let overlayLayers = {};
        let layerControl;
        let trendsChart; // Keep your existing variable


        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            createEnhancedLayerControl();
            initializeChart();
            setupEventListeners();
        });

        function initializeMap() {
            // Initialize Leaflet map
            villageMap = L.map('villageMap').setView([22.5726, 78.9629], 10);

            // ============================================================================
            // BASE LAYERS (Background maps)
            // ============================================================================
            
            // 1. OpenStreetMap (Default)
            baseLayers['Street Map'] = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            });

            // 2. Satellite Imagery
            baseLayers['Satellite'] = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: '© Google',
                maxZoom: 20
            });

            // 3. Hybrid (Satellite with labels)
            baseLayers['Hybrid'] = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                attribution: '© Google',
                maxZoom: 20
            });

            // 4. Terrain
            baseLayers['Terrain'] = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
                attribution: '© Google',
                maxZoom: 15
            });

            // 5. Topographic
            baseLayers['Topographic'] = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap',
                maxZoom: 17
            });

            // 6. Esri Satellite
            baseLayers['Esri Satellite'] = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri',
                maxZoom: 19
            });

            // ============================================================================
            // OVERLAY LAYERS (Data layers)
            // ============================================================================

            // 1. Bhuvan Land Use/Land Cover
            overlayLayers['Land Use (Bhuvan)'] = L.tileLayer.wms('https://bhuvan-vec2.nrsc.gov.in/bhuvan/wms', {
                layers: 'lulc:OR_LULC50K_1516',
                format: 'image/png',
                transparent: true,
                opacity: 0.7,
                attribution: '© NRSC/ISRO Bhuvan'
            });

            // 2. Forest Cover
            overlayLayers['Forest Cover'] = L.tileLayer.wms('https://bhuvan-vec1.nrsc.gov.in/bhuvan/wms', {
                layers: 'forest:forest_cover_2019',
                format: 'image/png',
                transparent: true,
                opacity: 0.8,
                attribution: '© NRSC/ISRO'
            });

            // 3. Village Boundaries Layer
            overlayLayers['Village Boundaries'] = L.layerGroup();
            
            // 4. FRA Claims Layer
            overlayLayers['FRA Claims'] = L.layerGroup();
            
            // 5. Infrastructure Layer
            overlayLayers['Infrastructure'] = L.layerGroup();

            // 6. Water Bodies
            overlayLayers['Water Bodies'] = L.tileLayer.wms('https://bhuvan-vec1.nrsc.gov.in/bhuvan/wms', {
                layers: 'waterbodies:water_bodies_2018',
                format: 'image/png',
                transparent: true,
                opacity: 0.6,
                attribution: '© NRSC/ISRO'
            });

            // Set default base layer
            baseLayers['Street Map'].addTo(villageMap);

            // Add sample data to layers
            addSampleData();

            // Add layer control
            layerControl = L.control.layers(baseLayers, overlayLayers, {
                position: 'topright',
                collapsed: false
            }).addTo(villageMap);

            console.log('Map initialized with full layer system');
        }

        function createEnhancedLayerControl() {
            // If a custom UI isn't present, fall back to Leaflet's default control
            const container = document.querySelector('.enhanced-layer-control');

            if (!container) {
                console.warn('Enhanced layer control container not found; using default Leaflet control');
                return;
            }

            container.innerHTML = '';

            const baseSection = document.createElement('div');
            baseSection.className = 'layer-section';
            baseSection.innerHTML = '<h5>Base Layers</h5>';

            Object.keys(baseLayers).forEach((baseName, index) => {
                const option = document.createElement('label');
                option.className = 'layer-option';

                option.innerHTML = `
                    <input type="radio" name="base-layer" value="${baseName}" ${index === 0 ? 'checked' : ''}>
                    <span>${baseName}</span>
                `;

                option.querySelector('input').addEventListener('change', () => {
                    Object.keys(baseLayers).forEach(name => {
                        if (villageMap.hasLayer(baseLayers[name])) {
                            villageMap.removeLayer(baseLayers[name]);
                        }
                    });
                    baseLayers[baseName].addTo(villageMap);
                });

                baseSection.appendChild(option);
            });

            const overlaySection = document.createElement('div');
            overlaySection.className = 'layer-section';
            overlaySection.innerHTML = '<h5>Overlays</h5>';

            Object.keys(overlayLayers).forEach((overlayName) => {
                const option = document.createElement('label');
                option.className = 'layer-option';

                const isVisible = villageMap.hasLayer(overlayLayers[overlayName]);

                option.innerHTML = `
                    <input type="checkbox" value="${overlayName}" ${isVisible ? 'checked' : ''}>
                    <span>${overlayName}</span>
                `;

                option.querySelector('input').addEventListener('change', (event) => {
                    if (event.target.checked) {
                        overlayLayers[overlayName].addTo(villageMap);
                    } else {
                        villageMap.removeLayer(overlayLayers[overlayName]);
                    }
                });

                overlaySection.appendChild(option);
            });

            container.appendChild(baseSection);
            container.appendChild(overlaySection);

            console.log('Enhanced layer control initialized');
        }

function addSampleData() {
    // Add FRA claims markers
    const sampleClaims = [
        { lat: 22.5726, lng: 78.9629, title: 'Claim 001', status: 'Approved', household: 'Gond Family', area: '2.1 ha' },
        { lat: 22.5782, lng: 78.9685, title: 'Claim 002', status: 'Pending', household: 'Munda Family', area: '1.6 ha' },
        { lat: 22.5698, lng: 78.9554, title: 'Claim 003', status: 'Approved', household: 'Baiga Community', area: '3.0 ha' },
        { lat: 22.5745, lng: 78.9472, title: 'Claim 004', status: 'Under Review', household: 'Korku Family', area: '1.2 ha' },
        { lat: 22.5820, lng: 78.9595, title: 'Claim 005', status: 'Approved', household: 'Halba Family', area: '2.4 ha' },
        { lat: 22.5662, lng: 78.9721, title: 'Claim 006', status: 'In Appeal', household: 'Bhil Family', area: '1.8 ha' },
        { lat: 22.5608, lng: 78.9633, title: 'Claim 007', status: 'Rejected', household: 'Pardhan Community', area: '0.9 ha' },
        { lat: 22.5857, lng: 78.9736, title: 'Claim 008', status: 'Pending', household: 'Kol Family', area: '2.7 ha' },
        { lat: 22.5590, lng: 78.9498, title: 'Claim 009', status: 'Approved', household: 'Gond Community', area: '3.4 ha' }
    ];

    const statusColors = {
        'Approved': '#16a34a',
        'Pending': '#f97316',
        'Under Review': '#facc15',
        'In Appeal': '#2563eb',
        'Rejected': '#dc2626'
    };

    sampleClaims.forEach(claim => {
        const statusColor = statusColors[claim.status] || '#6b7280';
        const pillBackground = `${statusColor}20`;
        const marker = L.circleMarker([claim.lat, claim.lng], {
            radius: 8,
            color: '#ffffff',
            weight: 2,
            fillColor: statusColor,
            fillOpacity: 0.9
        });
        marker.bindPopup(`
            <div class="popup-card">
                <div class="popup-icon">📄</div>
                <div>
                    <div class="status-pill" style="color:${statusColor};border:1px solid ${statusColor};background:${pillBackground};">${claim.status}</div>
                    <div class="popup-title">${claim.title}</div>
                    <div class="popup-desc"><strong>Household:</strong> ${claim.household}<br><strong>Area:</strong> ${claim.area}</div>
                </div>
            </div>
        `);
        overlayLayers['FRA Claims'].addLayer(marker);
    });

    // Add village boundary
    const villageBoundary = L.polygon([
        [22.5655, 78.9480],
        [22.5718, 78.9385],
        [22.5804, 78.9427],
        [22.5862, 78.9544],
        [22.5839, 78.9689],
        [22.5756, 78.9798],
        [22.5662, 78.9751],
        [22.5609, 78.9635],
        [22.5627, 78.9524]
    ], {
        color: '#1E3A8A',
        weight: 3,
        dashArray: '8 4',
        fillColor: '#3B82F6',
        fillOpacity: 0.25
    });
    villageBoundary.bindPopup('Khairwani Village Boundary');
    overlayLayers['Village Boundaries'].addLayer(villageBoundary);

    const balangirBoundary = L.polygon([
        [20.7135, 83.4750],
        [20.7210, 83.4828],
        [20.7248, 83.4942],
        [20.7182, 83.5055],
        [20.7081, 83.5079],
        [20.7016, 83.4970],
        [20.7047, 83.4824]
    ], {
        color: '#0f766e',
        weight: 3,
        dashArray: '6 4',
        fillColor: '#14b8a6',
        fillOpacity: 0.22
    });
    balangirBoundary.bindPopup(`
        <div class="popup-card">
            <div class="popup-icon">🗺️</div>
            <div>
                <div class="popup-meta">Balangir, Odisha</div>
                <div class="popup-title">Village Boundary - Bhainsa Sahi Cluster</div>
                <div class="popup-desc">Emerging peri-urban village cluster adjoining Balangir town with planned infrastructure upgrades.</div>
            </div>
        </div>
    `);
    overlayLayers['Village Boundaries'].addLayer(balangirBoundary);

    // Add infrastructure
    const infrastructureData = [
        { lat: 22.5750, lng: 78.9650, type: 'Hospital', name: 'PHC Khairwani', services: 'Primary healthcare & maternal care' },
        { lat: 22.5700, lng: 78.9600, type: 'School', name: 'Primary School', services: 'Classes I-V & midday meal' },
        { lat: 22.5800, lng: 78.9700, type: 'Post Office', name: 'Khairwani PO', services: 'Postal & banking services' },
        { lat: 22.5685, lng: 78.9530, type: 'Water Tank', name: 'Gram Panchayat Tank', services: '24KL storage with piped supply' },
        { lat: 22.5832, lng: 78.9638, type: 'Anganwadi Center', name: 'Bal Vikas Kendra', services: 'Nutrition & early learning' },
        { lat: 22.5714, lng: 78.9755, type: 'Community Center', name: 'Samudayik Bhavan', services: 'Meetings & SHG training' },
        { lat: 22.5642, lng: 78.9576, type: 'Solar Microgrid', name: 'Solar Power Hub', services: '35 kW village microgrid' },
        { lat: 22.5771, lng: 78.9485, type: 'Weekly Market', name: 'Haat Bazaar', services: 'Saturday agri-trade hub' },
        { lat: 22.5733, lng: 78.9812, type: 'Digital Service Center', name: 'CSC e-Seva Kendra', services: 'Aadhaar updates & e-governance services' },
        { lat: 22.5619, lng: 78.9558, type: 'Cold Storage', name: 'Farm Produce Hub', services: '15 MT cold chain for perishables' },
        { lat: 22.5865, lng: 78.9604, type: 'Irrigation Pump House', name: 'Lift Irrigation Point', services: 'River-fed irrigation covering 60 ha' },
        { lat: 22.5674, lng: 78.9421, type: 'Forest Watch Tower', name: 'Jungle Suraksha Post', services: 'Community-led forest vigilance' },
        { lat: 20.7162, lng: 83.4855, type: 'District Hospital', name: 'Balangir District Hospital Wing', services: 'Tele-ICU, maternal & newborn care expansion' },
        { lat: 20.7215, lng: 83.4920, type: 'Agri Hub', name: 'Balangir Krushi Bazaar Yard', services: 'Cold-chain and e-NAM farmer aggregation hub' },
        { lat: 20.7113, lng: 83.4746, type: 'Solar Water Pump', name: 'Saheed Nagar Solar Pumps', services: '24x7 drinking water via solar-powered pumps' },
        { lat: 20.7240, lng: 83.4998, type: 'Skill Center', name: 'Rajendra College Skill Lab', services: 'Digital skilling and tribal artisan incubation' }
    ];

    const infrastructureIcons = {
        'Hospital': '🏥',
        'School': '🏫',
        'Post Office': '📮',
        'Water Tank': '🚰',
        'Anganwadi Center': '👶',
        'Community Center': '🏡',
        'Solar Microgrid': '🔆',
        'Weekly Market': '🛒',
        'Digital Service Center': '💻',
        'Cold Storage': '❄️',
        'Irrigation Pump House': '🚜',
        'Forest Watch Tower': '🛖',
        'District Hospital': '🏥',
        'Agri Hub': '🌾',
        'Solar Water Pump': '💧',
        'Skill Center': '🎓'
    };

    infrastructureData.forEach(infra => {
        const icon = infrastructureIcons[infra.type] || '📍';

        const marker = L.marker([infra.lat, infra.lng], {
            icon: L.divIcon({
                html: `<div style="font-size: 20px;">${icon}</div>`,
                className: 'custom-div-icon',
                iconSize: [25, 25],
                iconAnchor: [12, 12]
            })
        });
        marker.bindPopup(`
            <div class="popup-card">
                <div class="popup-icon">${icon}</div>
                <div>
                    <div class="popup-meta">${infra.type}</div>
                    <div class="popup-title">${infra.name}</div>
                    <div class="popup-desc">${infra.services}</div>
                </div>
            </div>
        `);
        overlayLayers['Infrastructure'].addLayer(marker);
    });

    // Add default layers to map
    overlayLayers['Village Boundaries'].addTo(villageMap);
    overlayLayers['FRA Claims'].addTo(villageMap);
}


        function initializeChart() {
            const canvas = document.getElementById('trendsChart');
            if (!canvas) {
                console.error('❌ Chart canvas not found in DOM');
                return;
            }

            const ctx = canvas.getContext('2d');
            console.log('Chart canvas:', canvas, 'Context:', ctx);


            if (trendsChart) {
                trendsChart.destroy();
            }

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                    datasets: [
                        {
                            label: 'FRA Claims Processed',
                            data: [12,19,15,25,22,30,28,35,32,40,38,45],
                            borderColor: '#1E40AF',
                            backgroundColor: 'rgba(30, 64, 175, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Scheme Enrollments',
                            data: [8,15,12,18,16,24,22,28,26,32,30,36],
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5,150,105,0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Infrastructure Projects',
                            data: [3,5,4,7,6,9,8,11,10,13,12,15],
                            borderColor: '#DC2626',
                            backgroundColor: 'rgba(220,38,38,0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: {
                            display: true,
                            text: 'Monthly Development Progress',
                            font: { size: 14, weight: 'bold' },
                            color: '#374151'
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(0,0,0,0.1)' } },
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } }
                    }
                }
            });

            console.log('✅ Trends chart initialized successfully');
        }



        function setupEventListeners() {
            // Village selection change
            document.getElementById('villageSelect').addEventListener('change', function() {
                const selectedVillage = this.value;
                updateVillageData(selectedVillage);
            });

            // Layer control modal
            document.getElementById('layerToggle').addEventListener('click', function() {
                document.getElementById('layerModal').classList.remove('hidden');
            });

            document.getElementById('closeLayerModal').addEventListener('click', function() {
                document.getElementById('layerModal').classList.add('hidden');
            });

            document.getElementById('applyLayers').addEventListener('click', function() {
                // Apply layer visibility changes
                document.getElementById('layerModal').classList.add('hidden');
            });

            // Fullscreen map
            document.getElementById('fullscreenMap').addEventListener('click', function() {
                const mapContainer = document.getElementById('villageMap');
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                }
            });

            // Search functionality
            document.getElementById('villageSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                // Implement search logic here
                console.log('Searching for:', searchTerm);
            });

            // Export functionality
            document.querySelector('.btn-secondary').addEventListener('click', function() {
                // Simulate export
                alert('Village analytics report exported successfully!');
            });

            // Refresh data
            document.querySelector('.btn-primary').addEventListener('click', function() {
                // Simulate data refresh
                const button = this;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
                button.disabled = true;

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    alert('Data refreshed successfully!');
                }, 2000);
            });
        }

        function updateVillageData(villageId) {
            // Simulate updating village data based on selection
            console.log('Updating data for village:', villageId);
            
            // Update map center based on village
            const villageCoords = {
                'village1': [22.5726, 78.9629],
                'village2': [22.6726, 79.0629],
                'village3': [22.4726, 78.8629],
                'village4': [22.7726, 79.1629]
            };

            if (villageCoords[villageId]) {
                villageMap.setView(villageCoords[villageId], 12);
            }
        }

        // Mobile menu toggle (if needed)
        function toggleMobileMenu() {
            const nav = document.querySelector('nav');
            nav.classList.toggle('hidden');
        }
        

    </script>


<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>
